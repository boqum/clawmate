/**
 * 픽셀 아트 랍스터(Claw) 캐릭터 렌더러
 * 16x16 그리드 → CSS div로 렌더링 → 4x 확대 (64x64px)
 *
 * 색상 코드:
 *   0 = 투명, 1 = primary(빨강), 2 = secondary(연빨강),
 *   3 = dark(갈색), 4 = eye, 5 = pupil, 6 = claw 전용
 */
const Character = (() => {
  const PIXEL = 4;
  const GRID = 16;
  const SIZE = PIXEL * GRID;

  // --- 프레임 데이터 (16x16 배열) ---
  const FRAMES = {
    idle: [
      // Frame 0: 기본 자세 — 집게 열림
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,6,0,0,6,0,0,0,0,0,0,6,0,0,6,0],
        [0,6,0,0,6,0,0,0,0,0,0,6,0,0,6,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,0,6,1,1,0,0,0,0,1,1,6,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
        [0,0,1,2,1,1,1,1,1,1,1,1,2,1,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,3,3,3,0,3,3,3,3,0,3,3,3,0,0],
        [0,3,3,3,0,0,0,3,3,0,0,0,3,3,3,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
      // Frame 1: 집게 닫힘 (물결)
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,0,6,6,0,0,0,0,0,0,6,6,0,0,0],
        [0,0,0,6,1,1,0,0,0,0,1,1,6,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
        [0,0,1,2,1,1,1,1,1,1,1,1,2,1,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,3,3,3,0,3,3,3,3,0,3,3,3,0,0],
        [0,3,3,3,0,0,0,3,3,0,0,0,3,3,3,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
    ],

    walk: [
      // Frame 0: 왼쪽 다리 세트 앞으로 크게 벌림, 집게 열림
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,6,0,0,6,0,0,0,0,0,0,6,0,0,6,0],
        [0,6,0,0,6,0,0,0,0,0,0,6,0,0,6,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,0,6,1,1,0,0,0,0,1,1,6,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
        [0,0,1,2,1,1,1,1,1,1,1,1,2,1,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,3,3,0,0,0,3,3,3,3,0,0,0,3,3,0],
        [3,3,0,0,0,0,0,3,3,0,0,0,0,0,3,3],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
      // Frame 1: 양쪽 다리 모임 (접촉 순간), 집게 반 닫힘
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,6,0,6,0,0,0,0,0,0,6,0,6,0,0],
        [0,0,6,0,6,0,0,0,0,0,0,6,0,6,0,0],
        [0,0,0,6,6,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,0,6,1,1,0,0,0,0,1,1,6,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
        [0,0,1,2,1,1,1,1,1,1,1,1,2,1,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,3,3,0,3,3,3,3,0,3,3,0,0,0],
        [0,0,0,3,3,0,0,3,3,0,0,3,3,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
      // Frame 2: 오른쪽 다리 세트 앞으로 크게 벌림, 집게 닫힘
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,0,6,6,0,0,0,0,0,0,6,6,0,0,0],
        [0,0,0,6,1,1,0,0,0,0,1,1,6,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
        [0,0,1,2,1,1,1,1,1,1,1,1,2,1,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,3,3,0,0,3,3,3,3,0,0,3,3,0,0],
        [0,3,3,0,0,0,0,3,3,0,0,0,0,3,3,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
      // Frame 3: 양쪽 다리 모임 (접촉 순간), 집게 반 열림
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,6,0,0,6,0,0,0,0,0,0,6,0,0,6,0],
        [0,6,0,0,6,0,0,0,0,0,0,6,0,0,6,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,0,6,1,1,0,0,0,0,1,1,6,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
        [0,0,1,2,1,1,1,1,1,1,1,1,2,1,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,3,3,0,3,3,3,3,0,3,3,0,0,0],
        [0,0,0,3,3,0,0,3,3,0,0,3,3,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
    ],

    climb: [
      // Frame 0: 기어오르기 — 윗다리 세트 뻗음, 집게 열림
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,6,6,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,6,0,0,6,0,0,0,0,0,0,0,0,0],
        [0,0,0,6,0,0,6,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,6,6,1,1,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0],
        [0,0,0,0,1,4,5,1,1,0,0,0,0,0,0,0],
        [0,0,0,0,1,4,5,1,1,1,0,0,0,0,0,0],
        [0,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0],
        [0,0,0,1,2,1,1,1,1,0,0,0,0,0,0,0],
        [0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0],
        [0,0,3,3,0,0,0,3,3,0,0,0,0,0,0,0],
        [0,3,3,0,0,0,0,0,3,3,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
      // Frame 1: 기어오르기 — 다리 모임 (교차 순간)
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,6,6,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,6,0,0,6,0,0,0,0,0,0,0,0,0],
        [0,0,0,6,0,0,6,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,6,6,1,1,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0],
        [0,0,0,0,1,4,5,1,1,0,0,0,0,0,0,0],
        [0,0,0,0,1,4,5,1,1,1,0,0,0,0,0,0],
        [0,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0],
        [0,0,0,1,2,1,1,1,1,0,0,0,0,0,0,0],
        [0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0],
        [0,0,0,3,3,0,3,3,0,0,0,0,0,0,0,0],
        [0,0,0,3,3,0,3,3,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
      // Frame 2: 기어오르기 — 아랫다리 세트 뻗음, 집게 닫힘
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,6,6,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,6,6,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,6,6,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,6,6,1,1,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0],
        [0,0,0,0,1,4,5,1,1,0,0,0,0,0,0,0],
        [0,0,0,0,1,4,5,1,1,1,0,0,0,0,0,0],
        [0,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0],
        [0,0,0,1,2,1,1,1,1,0,0,0,0,0,0,0],
        [0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0],
        [0,0,0,3,3,0,3,3,0,0,0,0,0,0,0,0],
        [0,0,3,3,0,0,0,3,3,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
      // Frame 3: 기어오르기 — 다리 모임 (교차 순간, 반대쪽)
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,6,6,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,6,6,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,6,6,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,6,6,1,1,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0],
        [0,0,0,0,1,4,5,1,1,0,0,0,0,0,0,0],
        [0,0,0,0,1,4,5,1,1,1,0,0,0,0,0,0],
        [0,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0],
        [0,0,0,1,2,1,1,1,1,0,0,0,0,0,0,0],
        [0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0],
        [0,0,3,3,0,0,0,3,3,0,0,0,0,0,0,0],
        [0,0,3,3,0,0,0,3,3,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
    ],

    sleep: [
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,0,6,6,0,0,0,0,0,0,6,6,0,0,0],
        [0,0,0,6,1,1,0,0,0,0,1,1,6,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,1,1,3,3,1,1,3,3,1,1,0,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
        [0,0,1,2,1,1,1,1,1,1,1,1,2,1,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,3,3,3,0,3,3,3,3,0,3,3,3,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
    ],

    carry: [
      // Frame 0: 파일 들고 걷기 1
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,6,1,1,1,1,0,0,1,1,1,1,6,0,0],
        [0,0,6,1,2,2,1,0,0,1,2,2,1,6,0,0],
        [0,0,6,1,1,1,1,0,0,1,1,1,1,6,0,0],
        [0,0,0,6,1,1,0,0,0,0,1,1,6,0,0,0],
        [0,0,0,6,1,1,0,0,0,0,1,1,6,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
        [0,0,1,2,1,1,1,1,1,1,1,1,2,1,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,3,3,3,0,3,3,3,3,0,0,3,3,3,0],
        [0,3,3,3,0,0,0,3,3,0,0,0,3,3,3,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
      // Frame 1: 파일 들고 걷기 2
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,6,1,1,1,1,0,0,1,1,1,1,6,0,0],
        [0,0,6,1,2,2,1,0,0,1,2,2,1,6,0,0],
        [0,0,6,1,1,1,1,0,0,1,1,1,1,6,0,0],
        [0,0,0,6,1,1,0,0,0,0,1,1,6,0,0,0],
        [0,0,0,6,1,1,0,0,0,0,1,1,6,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
        [0,0,1,2,1,1,1,1,1,1,1,1,2,1,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,3,3,3,0,3,3,0,3,3,3,0,0,0],
        [0,0,0,0,3,3,3,0,0,3,3,3,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
    ],

    scared: [
      // Frame 0: 놀람 — 눈 크게
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,6,0,0,6,0,0,0,0,0,0,6,0,0,6,0],
        [0,6,0,0,6,0,0,0,0,0,0,6,0,0,6,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,0,6,1,1,0,0,0,0,1,1,6,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,1,4,4,5,1,1,4,4,5,1,0,0,0],
        [0,0,0,1,4,4,5,1,1,4,4,5,1,0,0,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
        [0,0,1,2,1,1,1,1,1,1,1,1,2,1,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,3,3,3,0,3,3,3,3,0,0,3,3,3,0],
        [0,3,3,3,0,0,0,3,3,0,0,0,3,3,3,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
      // Frame 1: 뒤로 움찔
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,6,6,0,0,0,0,0,0,6,6,0,0,0],
        [0,0,6,0,0,6,0,0,0,0,6,0,0,6,0,0],
        [0,0,6,0,0,6,0,0,0,0,6,0,0,6,0,0],
        [0,0,0,6,6,0,0,0,0,0,0,6,6,0,0,0],
        [0,0,0,0,6,1,1,0,0,1,1,6,0,0,0,0],
        [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
        [0,0,0,0,1,4,4,5,4,4,5,1,0,0,0,0],
        [0,0,0,0,1,4,4,5,4,4,5,1,0,0,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,0,1,2,1,1,1,1,1,1,2,1,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
        [0,0,0,3,3,3,0,3,3,0,3,3,3,0,0,0],
        [0,0,3,3,3,0,0,0,0,0,0,3,3,3,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
    ],

    excited: [
      // Frame 0: 점프 업
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,6,6,0,0,0,0,0,0,0,0,0,0,6,6,0],
        [6,0,0,6,0,0,0,0,0,0,0,0,6,0,0,6],
        [6,0,0,6,0,0,0,0,0,0,0,0,6,0,0,6],
        [0,6,6,0,0,0,0,0,0,0,0,0,0,6,6,0],
        [0,0,6,1,1,0,0,0,0,0,0,1,1,6,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,1,1,4,5,1,1,1,1,4,5,1,1,0,0],
        [0,0,1,1,4,5,1,1,1,1,4,5,1,1,0,0],
        [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
        [0,1,2,1,1,1,1,1,1,1,1,1,1,2,1,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
      // Frame 1: 착지
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,6,0,0,6,0,0,0,0,0,0,6,0,0,6,0],
        [0,6,0,0,6,0,0,0,0,0,0,6,0,0,6,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,0,6,1,1,0,0,0,0,1,1,6,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
        [0,0,1,2,1,1,1,1,1,1,1,1,2,1,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [3,3,3,3,3,0,3,3,3,3,0,3,3,3,3,3],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
    ],
  };

  // 상태 → 프레임셋 매핑
  const STATE_FRAMES = {
    idle: 'idle',
    walking: 'walk',
    climbing_up: 'climb',
    climbing_down: 'climb',
    ceiling_walk: 'walk',
    sleeping: 'sleep',
    carrying: 'carry',
    playing: 'idle',
    interacting: 'excited',
    scared: 'scared',
    excited: 'excited',
    jumping: 'excited',    // 점프: excited 프레임셋 재활용
    rappelling: 'climb',   // 레펠: climb 프레임셋 재활용
    falling: 'scared',     // 낙하: scared 프레임셋 재활용
    custom: 'walk',        // 커스텀 이동: 기본은 walk, 패턴별로 동적 변경 가능
  };

  let currentCanvas = null;
  let currentColorMap = null;
  let originalFrames = null;  // 원본 프레임 백업 (리셋용)

  function createCanvas(container) {
    const canvas = document.createElement('canvas');
    canvas.width = SIZE;
    canvas.height = SIZE;
    canvas.style.width = SIZE + 'px';
    canvas.style.height = SIZE + 'px';
    canvas.style.imageRendering = 'pixelated';
    container.appendChild(canvas);
    currentCanvas = canvas;
    return canvas;
  }

  function setColorMap(colors) {
    currentColorMap = {
      0: 'transparent',
      1: colors.primary,
      2: colors.secondary,
      3: colors.dark,
      4: colors.eye,
      5: colors.pupil,
      6: colors.claw || colors.primary,
    };
  }

  function renderFrame(state, frameIndex, flipX = false) {
    if (!currentCanvas || !currentColorMap) return;
    const ctx = currentCanvas.getContext('2d');
    ctx.clearRect(0, 0, SIZE, SIZE);

    const frameSet = STATE_FRAMES[state] || 'idle';
    const frames = FRAMES[frameSet];
    if (!frames) return;

    const frame = frames[frameIndex % frames.length];
    if (!frame) return;

    for (let y = 0; y < GRID; y++) {
      for (let x = 0; x < GRID; x++) {
        const colorCode = frame[y][x];
        if (colorCode === 0) continue;
        const color = currentColorMap[colorCode] || 'transparent';
        if (color === 'transparent') continue;

        ctx.fillStyle = color;
        const drawX = flipX ? (GRID - 1 - x) * PIXEL : x * PIXEL;
        ctx.fillRect(drawX, y * PIXEL, PIXEL, PIXEL);
      }
    }
  }

  function getFrameCount(state) {
    const frameSet = STATE_FRAMES[state] || 'idle';
    return (FRAMES[frameSet] || FRAMES.idle).length;
  }

  /**
   * 커스텀 프레임 데이터 설정 (AI 생성 캐릭터용)
   * 기존 프레임을 백업하고 새 프레임으로 교체
   */
  function setCustomFrames(newFrames) {
    if (!originalFrames) {
      originalFrames = {};
      for (const [key, value] of Object.entries(FRAMES)) {
        originalFrames[key] = JSON.parse(JSON.stringify(value));
      }
    }
    for (const [key, value] of Object.entries(newFrames)) {
      if (Array.isArray(value) && value.length > 0) {
        FRAMES[key] = value;
      }
    }
  }

  /**
   * 캐릭터 데이터 일괄 설정 (색상 + 프레임)
   * @param {object} data - { colorMap?, frames? }
   */
  function setCharacterData(data) {
    if (data.colorMap) {
      setColorMap(data.colorMap);
    }
    if (data.frames) {
      setCustomFrames(data.frames);
    }
  }

  /**
   * 원래 캐릭터로 리셋
   */
  function resetCharacter() {
    if (originalFrames) {
      for (const key of Object.keys(FRAMES)) {
        delete FRAMES[key];
      }
      Object.assign(FRAMES, originalFrames);
      originalFrames = null;
    }
    // 기본 색상으로 리셋
    setColorMap({
      primary: '#ff4f40',
      secondary: '#ff775f',
      dark: '#8B4513',
      eye: '#ffffff',
      pupil: '#111111',
      claw: '#ff4f40',
    });
  }

  return {
    createCanvas, setColorMap, renderFrame, getFrameCount,
    setCustomFrames, setCharacterData, resetCharacter,
    SIZE, FRAMES, STATE_FRAMES,
  };
})();
