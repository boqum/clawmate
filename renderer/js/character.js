/**
 * 픽셀 아트 랍스터(Claw) 캐릭터 렌더러
 * 16x16 그리드 → CSS div로 렌더링 → 4x 확대 (64x64px)
 *
 * 색상 코드:
 *   0 = 투명, 1 = primary(빨강), 2 = secondary(연빨강),
 *   3 = dark(갈색), 4 = eye, 5 = pupil, 6 = claw 전용
 */
const Character = (() => {
  const PIXEL = 4;
  const GRID = 16;
  const SIZE = PIXEL * GRID;

  // --- 프레임 데이터 (16x16 배열) ---
  const FRAMES = {
    idle: [
      // Frame 0: 기본 자세 — 집게 열림
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,6,0,0,6,0,0,0,0,0,0,6,0,0,6,0],
        [0,6,0,0,6,0,0,0,0,0,0,6,0,0,6,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,0,6,1,1,0,0,0,0,1,1,6,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
        [0,0,1,2,1,1,1,1,1,1,1,1,2,1,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,3,3,0,3,3,3,3,0,3,3,0,0,0],
        [0,0,3,3,0,0,0,3,3,0,0,0,3,3,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
      // Frame 1: 집게 닫힘 (물결)
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,0,6,6,0,0,0,0,0,0,6,6,0,0,0],
        [0,0,0,6,1,1,0,0,0,0,1,1,6,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
        [0,0,1,2,1,1,1,1,1,1,1,1,2,1,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,3,3,0,3,3,3,3,0,3,3,0,0,0],
        [0,0,3,3,0,0,0,3,3,0,0,0,3,3,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
    ],

    walk: [
      // Frame 0: 왼발 앞
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,6,0,0,6,0,0,0,0,0,0,6,0,0,6,0],
        [0,6,0,0,6,0,0,0,0,0,0,6,0,0,6,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,0,6,1,1,0,0,0,0,1,1,6,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
        [0,0,1,2,1,1,1,1,1,1,1,1,2,1,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,3,3,0,0,3,3,3,3,0,0,3,3,0,0],
        [0,3,3,0,0,0,0,3,3,0,0,0,0,3,3,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
      // Frame 1: 오른발 앞
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,6,0,0,6,0,0,0,0,0,0,6,0,0,6,0],
        [0,6,0,0,6,0,0,0,0,0,0,6,0,0,6,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,0,6,1,1,0,0,0,0,1,1,6,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
        [0,0,1,2,1,1,1,1,1,1,1,1,2,1,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,3,3,0,0,3,3,0,0,3,3,0,0,0],
        [0,0,0,0,3,3,0,0,0,0,3,3,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
      // Frame 2: 왼발 뒤
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,0,6,6,0,0,0,0,0,0,6,6,0,0,0],
        [0,0,0,6,1,1,0,0,0,0,1,1,6,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
        [0,0,1,2,1,1,1,1,1,1,1,1,2,1,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,3,3,0,0,3,3,3,3,0,0,3,3,0,0],
        [0,3,3,0,0,0,0,3,3,0,0,0,0,3,3,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
      // Frame 3: 오른발 뒤
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,0,6,6,0,0,0,0,0,0,6,6,0,0,0],
        [0,0,0,6,1,1,0,0,0,0,1,1,6,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
        [0,0,1,2,1,1,1,1,1,1,1,1,2,1,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,3,3,0,0,3,3,0,0,3,3,0,0,0],
        [0,0,0,0,3,3,0,0,0,0,3,3,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
    ],

    climb: [
      // Frame 0: 기어오르기 포즈 1 (옆모습)
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,6,6,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,6,0,0,6,0,0,0,0,0,0,0,0,0],
        [0,0,0,6,0,0,6,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,6,6,1,1,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0],
        [0,0,0,0,1,4,5,1,1,0,0,0,0,0,0,0],
        [0,0,0,0,1,4,5,1,1,1,0,0,0,0,0,0],
        [0,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0],
        [0,0,0,1,2,1,1,1,1,0,0,0,0,0,0,0],
        [0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0],
        [0,0,0,0,3,0,3,0,0,0,0,0,0,0,0,0],
        [0,0,0,3,0,0,0,3,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
      // Frame 1: 기어오르기 포즈 2
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,6,6,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,6,0,0,6,0,0,0,0,0,0,0,0,0],
        [0,0,0,6,0,0,6,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,6,6,1,1,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0],
        [0,0,0,0,1,4,5,1,1,0,0,0,0,0,0,0],
        [0,0,0,0,1,4,5,1,1,1,0,0,0,0,0,0],
        [0,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0],
        [0,0,0,1,2,1,1,1,1,0,0,0,0,0,0,0],
        [0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0],
        [0,0,0,3,0,0,0,3,0,0,0,0,0,0,0,0],
        [0,0,0,0,3,0,3,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
    ],

    sleep: [
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,0,6,6,0,0,0,0,0,0,6,6,0,0,0],
        [0,0,0,6,1,1,0,0,0,0,1,1,6,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,1,1,3,3,1,1,3,3,1,1,0,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
        [0,0,1,2,1,1,1,1,1,1,1,1,2,1,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,3,3,0,3,3,3,3,0,3,3,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
    ],

    carry: [
      // Frame 0: 파일 들고 걷기 1
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,6,1,1,1,1,0,0,1,1,1,1,6,0,0],
        [0,0,6,1,2,2,1,0,0,1,2,2,1,6,0,0],
        [0,0,6,1,1,1,1,0,0,1,1,1,1,6,0,0],
        [0,0,0,6,1,1,0,0,0,0,1,1,6,0,0,0],
        [0,0,0,6,1,1,0,0,0,0,1,1,6,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
        [0,0,1,2,1,1,1,1,1,1,1,1,2,1,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,3,3,0,0,3,3,3,3,0,0,3,3,0,0],
        [0,3,3,0,0,0,0,3,3,0,0,0,0,3,3,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
      // Frame 1: 파일 들고 걷기 2
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,6,1,1,1,1,0,0,1,1,1,1,6,0,0],
        [0,0,6,1,2,2,1,0,0,1,2,2,1,6,0,0],
        [0,0,6,1,1,1,1,0,0,1,1,1,1,6,0,0],
        [0,0,0,6,1,1,0,0,0,0,1,1,6,0,0,0],
        [0,0,0,6,1,1,0,0,0,0,1,1,6,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
        [0,0,1,2,1,1,1,1,1,1,1,1,2,1,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,3,3,0,0,3,3,0,0,3,3,0,0,0],
        [0,0,0,0,3,3,0,0,0,0,3,3,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
    ],

    scared: [
      // Frame 0: 놀람 — 눈 크게
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,6,0,0,6,0,0,0,0,0,0,6,0,0,6,0],
        [0,6,0,0,6,0,0,0,0,0,0,6,0,0,6,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,0,6,1,1,0,0,0,0,1,1,6,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,1,4,4,5,1,1,4,4,5,1,0,0,0],
        [0,0,0,1,4,4,5,1,1,4,4,5,1,0,0,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
        [0,0,1,2,1,1,1,1,1,1,1,1,2,1,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,3,3,0,0,3,3,3,3,0,0,3,3,0,0],
        [0,3,3,0,0,0,0,3,3,0,0,0,0,3,3,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
      // Frame 1: 뒤로 움찔
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,6,6,0,0,0,0,0,0,6,6,0,0,0],
        [0,0,6,0,0,6,0,0,0,0,6,0,0,6,0,0],
        [0,0,6,0,0,6,0,0,0,0,6,0,0,6,0,0],
        [0,0,0,6,6,0,0,0,0,0,0,6,6,0,0,0],
        [0,0,0,0,6,1,1,0,0,1,1,6,0,0,0,0],
        [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
        [0,0,0,0,1,4,4,5,4,4,5,1,0,0,0,0],
        [0,0,0,0,1,4,4,5,4,4,5,1,0,0,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,0,1,2,1,1,1,1,1,1,2,1,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
        [0,0,0,0,3,3,0,3,3,0,3,3,0,0,0,0],
        [0,0,0,3,3,0,0,0,0,0,0,3,3,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
    ],

    excited: [
      // Frame 0: 점프 업
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,6,6,0,0,0,0,0,0,0,0,0,0,6,6,0],
        [6,0,0,6,0,0,0,0,0,0,0,0,6,0,0,6],
        [6,0,0,6,0,0,0,0,0,0,0,0,6,0,0,6],
        [0,6,6,0,0,0,0,0,0,0,0,0,0,6,6,0],
        [0,0,6,1,1,0,0,0,0,0,0,1,1,6,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,1,1,4,5,1,1,1,1,4,5,1,1,0,0],
        [0,0,1,1,4,5,1,1,1,1,4,5,1,1,0,0],
        [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
        [0,1,2,1,1,1,1,1,1,1,1,1,1,2,1,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
      // Frame 1: 착지
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,6,0,0,6,0,0,0,0,0,0,6,0,0,6,0],
        [0,6,0,0,6,0,0,0,0,0,0,6,0,0,6,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,0,6,1,1,0,0,0,0,1,1,6,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
        [0,0,1,2,1,1,1,1,1,1,1,1,2,1,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,3,3,3,3,0,3,3,3,3,0,3,3,3,3,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
    ],
  };

  // 상태 → 프레임셋 매핑
  const STATE_FRAMES = {
    idle: 'idle',
    walking: 'walk',
    climbing_up: 'climb',
    climbing_down: 'climb',
    ceiling_walk: 'walk',
    sleeping: 'sleep',
    carrying: 'carry',
    playing: 'idle',
    interacting: 'excited',
    scared: 'scared',
    excited: 'excited',
  };

  let currentCanvas = null;
  let currentColorMap = null;

  function createCanvas(container) {
    const canvas = document.createElement('canvas');
    canvas.width = SIZE;
    canvas.height = SIZE;
    canvas.style.width = SIZE + 'px';
    canvas.style.height = SIZE + 'px';
    canvas.style.imageRendering = 'pixelated';
    container.appendChild(canvas);
    currentCanvas = canvas;
    return canvas;
  }

  function setColorMap(colors) {
    currentColorMap = {
      0: 'transparent',
      1: colors.primary,
      2: colors.secondary,
      3: colors.dark,
      4: colors.eye,
      5: colors.pupil,
      6: colors.claw || colors.primary,
    };
  }

  function renderFrame(state, frameIndex, flipX = false) {
    if (!currentCanvas || !currentColorMap) return;
    const ctx = currentCanvas.getContext('2d');
    ctx.clearRect(0, 0, SIZE, SIZE);

    const frameSet = STATE_FRAMES[state] || 'idle';
    const frames = FRAMES[frameSet];
    if (!frames) return;

    const frame = frames[frameIndex % frames.length];
    if (!frame) return;

    for (let y = 0; y < GRID; y++) {
      for (let x = 0; x < GRID; x++) {
        const colorCode = frame[y][x];
        if (colorCode === 0) continue;
        const color = currentColorMap[colorCode] || 'transparent';
        if (color === 'transparent') continue;

        ctx.fillStyle = color;
        const drawX = flipX ? (GRID - 1 - x) * PIXEL : x * PIXEL;
        ctx.fillRect(drawX, y * PIXEL, PIXEL, PIXEL);
      }
    }
  }

  function getFrameCount(state) {
    const frameSet = STATE_FRAMES[state] || 'idle';
    return (FRAMES[frameSet] || FRAMES.idle).length;
  }

  return { createCanvas, setColorMap, renderFrame, getFrameCount, SIZE, FRAMES, STATE_FRAMES };
})();
