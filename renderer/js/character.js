/**
 * Pixel art lobster (Claw) character renderer
 * 16x16 grid -> rendered as CSS div -> 4x scaled (64x64px)
 *
 * Color codes:
 *   0 = transparent, 1 = primary (red), 2 = secondary (light red),
 *   3 = dark (brown), 4 = eye, 5 = pupil, 6 = claw specific
 */
const Character = (() => {
  const PIXEL = 4;
  const GRID = 16;
  const SIZE = PIXEL * GRID;

  // --- Frame data (16x16 arrays) ---
  const FRAMES = {
    idle: [
      // Frame 0: Default pose -- claws open
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,6,0,0,6,0,0,0,0,0,0,6,0,0,6,0],
        [0,6,0,0,6,0,0,0,0,0,0,6,0,0,6,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,0,6,1,1,0,0,0,0,1,1,6,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
        [0,0,1,2,1,1,1,1,1,1,1,1,2,1,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,3,3,3,0,3,3,3,3,0,3,3,3,0,0],
        [0,3,3,3,0,0,0,3,3,0,0,0,3,3,3,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
      // Frame 1: Claws closed (wave)
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,0,6,6,0,0,0,0,0,0,6,6,0,0,0],
        [0,0,0,6,1,1,0,0,0,0,1,1,6,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
        [0,0,1,2,1,1,1,1,1,1,1,1,2,1,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,3,3,3,0,3,3,3,3,0,3,3,3,0,0],
        [0,3,3,3,0,0,0,3,3,0,0,0,3,3,3,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
    ],

    walk: [
      // Frame 0: Left leg set extended forward wide, claws open
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,6,0,0,6,0,0,0,0,0,0,6,0,0,6,0],
        [0,6,0,0,6,0,0,0,0,0,0,6,0,0,6,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,0,6,1,1,0,0,0,0,1,1,6,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
        [0,0,1,2,1,1,1,1,1,1,1,1,2,1,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,3,3,0,0,0,3,3,3,3,0,0,0,3,3,0],
        [3,3,0,0,0,0,0,3,3,0,0,0,0,0,3,3],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
      // Frame 1: Both leg sets together (contact moment), claws half-closed
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,6,0,6,0,0,0,0,0,0,6,0,6,0,0],
        [0,0,6,0,6,0,0,0,0,0,0,6,0,6,0,0],
        [0,0,0,6,6,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,0,6,1,1,0,0,0,0,1,1,6,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
        [0,0,1,2,1,1,1,1,1,1,1,1,2,1,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,3,3,0,3,3,3,3,0,3,3,0,0,0],
        [0,0,0,3,3,0,0,3,3,0,0,3,3,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
      // Frame 2: Right leg set extended forward wide, claws closed
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,0,6,6,0,0,0,0,0,0,6,6,0,0,0],
        [0,0,0,6,1,1,0,0,0,0,1,1,6,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
        [0,0,1,2,1,1,1,1,1,1,1,1,2,1,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,3,3,0,0,3,3,3,3,0,0,3,3,0,0],
        [0,3,3,0,0,0,0,3,3,0,0,0,0,3,3,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
      // Frame 3: Both leg sets together (contact moment), claws half-open
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,6,0,0,6,0,0,0,0,0,0,6,0,0,6,0],
        [0,6,0,0,6,0,0,0,0,0,0,6,0,0,6,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,0,6,1,1,0,0,0,0,1,1,6,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
        [0,0,1,2,1,1,1,1,1,1,1,1,2,1,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,3,3,0,3,3,3,3,0,3,3,0,0,0],
        [0,0,0,3,3,0,0,3,3,0,0,3,3,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
    ],

    climb: [
      // Frame 0: Climbing -- upper leg set extended, claws open
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,6,6,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,6,0,0,6,0,0,0,0,0,0,0,0,0],
        [0,0,0,6,0,0,6,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,6,6,1,1,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0],
        [0,0,0,0,1,4,5,1,1,0,0,0,0,0,0,0],
        [0,0,0,0,1,4,5,1,1,1,0,0,0,0,0,0],
        [0,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0],
        [0,0,0,1,2,1,1,1,1,0,0,0,0,0,0,0],
        [0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0],
        [0,0,3,3,0,0,0,3,3,0,0,0,0,0,0,0],
        [0,3,3,0,0,0,0,0,3,3,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
      // Frame 1: Climbing -- legs together (crossing moment)
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,6,6,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,6,0,0,6,0,0,0,0,0,0,0,0,0],
        [0,0,0,6,0,0,6,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,6,6,1,1,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0],
        [0,0,0,0,1,4,5,1,1,0,0,0,0,0,0,0],
        [0,0,0,0,1,4,5,1,1,1,0,0,0,0,0,0],
        [0,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0],
        [0,0,0,1,2,1,1,1,1,0,0,0,0,0,0,0],
        [0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0],
        [0,0,0,3,3,0,3,3,0,0,0,0,0,0,0,0],
        [0,0,0,3,3,0,3,3,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
      // Frame 2: Climbing -- lower leg set extended, claws closed
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,6,6,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,6,6,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,6,6,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,6,6,1,1,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0],
        [0,0,0,0,1,4,5,1,1,0,0,0,0,0,0,0],
        [0,0,0,0,1,4,5,1,1,1,0,0,0,0,0,0],
        [0,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0],
        [0,0,0,1,2,1,1,1,1,0,0,0,0,0,0,0],
        [0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0],
        [0,0,0,3,3,0,3,3,0,0,0,0,0,0,0,0],
        [0,0,3,3,0,0,0,3,3,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
      // Frame 3: Climbing -- legs together (crossing moment, opposite side)
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,6,6,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,6,6,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,6,6,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,6,6,1,1,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0],
        [0,0,0,0,1,4,5,1,1,0,0,0,0,0,0,0],
        [0,0,0,0,1,4,5,1,1,1,0,0,0,0,0,0],
        [0,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0],
        [0,0,0,1,2,1,1,1,1,0,0,0,0,0,0,0],
        [0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0],
        [0,0,3,3,0,0,0,3,3,0,0,0,0,0,0,0],
        [0,0,3,3,0,0,0,3,3,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
    ],

    sleep: [
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,0,6,6,0,0,0,0,0,0,6,6,0,0,0],
        [0,0,0,6,1,1,0,0,0,0,1,1,6,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,1,1,3,3,1,1,3,3,1,1,0,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
        [0,0,1,2,1,1,1,1,1,1,1,1,2,1,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,3,3,3,0,3,3,3,3,0,3,3,3,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
    ],

    carry: [
      // Frame 0: Walking with file 1
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,6,1,1,1,1,0,0,1,1,1,1,6,0,0],
        [0,0,6,1,2,2,1,0,0,1,2,2,1,6,0,0],
        [0,0,6,1,1,1,1,0,0,1,1,1,1,6,0,0],
        [0,0,0,6,1,1,0,0,0,0,1,1,6,0,0,0],
        [0,0,0,6,1,1,0,0,0,0,1,1,6,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
        [0,0,1,2,1,1,1,1,1,1,1,1,2,1,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,3,3,3,0,3,3,3,3,0,0,3,3,3,0],
        [0,3,3,3,0,0,0,3,3,0,0,0,3,3,3,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
      // Frame 1: Walking with file 2
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,6,1,1,1,1,0,0,1,1,1,1,6,0,0],
        [0,0,6,1,2,2,1,0,0,1,2,2,1,6,0,0],
        [0,0,6,1,1,1,1,0,0,1,1,1,1,6,0,0],
        [0,0,0,6,1,1,0,0,0,0,1,1,6,0,0,0],
        [0,0,0,6,1,1,0,0,0,0,1,1,6,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
        [0,0,1,2,1,1,1,1,1,1,1,1,2,1,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,3,3,3,0,3,3,0,3,3,3,0,0,0],
        [0,0,0,0,3,3,3,0,0,3,3,3,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
    ],

    scared: [
      // Frame 0: Startled -- eyes wide
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,6,0,0,6,0,0,0,0,0,0,6,0,0,6,0],
        [0,6,0,0,6,0,0,0,0,0,0,6,0,0,6,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,0,6,1,1,0,0,0,0,1,1,6,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,1,4,4,5,1,1,4,4,5,1,0,0,0],
        [0,0,0,1,4,4,5,1,1,4,4,5,1,0,0,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
        [0,0,1,2,1,1,1,1,1,1,1,1,2,1,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,3,3,3,0,3,3,3,3,0,0,3,3,3,0],
        [0,3,3,3,0,0,0,3,3,0,0,0,3,3,3,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
      // Frame 1: Flinch backward
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,6,6,0,0,0,0,0,0,6,6,0,0,0],
        [0,0,6,0,0,6,0,0,0,0,6,0,0,6,0,0],
        [0,0,6,0,0,6,0,0,0,0,6,0,0,6,0,0],
        [0,0,0,6,6,0,0,0,0,0,0,6,6,0,0,0],
        [0,0,0,0,6,1,1,0,0,1,1,6,0,0,0,0],
        [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
        [0,0,0,0,1,4,4,5,4,4,5,1,0,0,0,0],
        [0,0,0,0,1,4,4,5,4,4,5,1,0,0,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,0,1,2,1,1,1,1,1,1,2,1,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
        [0,0,0,3,3,3,0,3,3,0,3,3,3,0,0,0],
        [0,0,3,3,3,0,0,0,0,0,0,3,3,3,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
    ],

    excited: [
      // Frame 0: Jump up
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,6,6,0,0,0,0,0,0,0,0,0,0,6,6,0],
        [6,0,0,6,0,0,0,0,0,0,0,0,6,0,0,6],
        [6,0,0,6,0,0,0,0,0,0,0,0,6,0,0,6],
        [0,6,6,0,0,0,0,0,0,0,0,0,0,6,6,0],
        [0,0,6,1,1,0,0,0,0,0,0,1,1,6,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,1,1,4,5,1,1,1,1,4,5,1,1,0,0],
        [0,0,1,1,4,5,1,1,1,1,4,5,1,1,0,0],
        [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
        [0,1,2,1,1,1,1,1,1,1,1,1,1,2,1,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
      // Frame 1: Landing
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,6,0,0,6,0,0,0,0,0,0,6,0,0,6,0],
        [0,6,0,0,6,0,0,0,0,0,0,6,0,0,6,0],
        [0,0,6,6,0,0,0,0,0,0,0,0,6,6,0,0],
        [0,0,0,6,1,1,0,0,0,0,1,1,6,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,0,1,1,4,5,1,1,4,5,1,1,0,0,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
        [0,0,1,2,1,1,1,1,1,1,1,1,2,1,0,0],
        [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
        [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
        [3,3,3,3,3,0,3,3,3,3,0,3,3,3,3,3],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      ],
    ],
  };

  // State -> frameset mapping
  const STATE_FRAMES = {
    idle: 'idle',
    walking: 'walk',
    climbing_up: 'climb',
    climbing_down: 'climb',
    ceiling_walk: 'walk',
    sleeping: 'sleep',
    carrying: 'carry',
    playing: 'idle',
    interacting: 'excited',
    scared: 'scared',
    excited: 'excited',
    jumping: 'excited',    // Jump: reuse excited frameset
    rappelling: 'climb',   // Rappel: reuse climb frameset
    falling: 'scared',     // Falling: reuse scared frameset
    custom: 'walk',        // Custom movement: default is walk, can be dynamically changed per pattern
  };

  let currentCanvas = null;
  let currentColorMap = null;
  let originalFrames = null;  // Original frame backup (for reset)

  function createCanvas(container) {
    const canvas = document.createElement('canvas');
    canvas.width = SIZE;
    canvas.height = SIZE;
    canvas.style.width = SIZE + 'px';
    canvas.style.height = SIZE + 'px';
    canvas.style.imageRendering = 'pixelated';
    container.appendChild(canvas);
    currentCanvas = canvas;
    return canvas;
  }

  function setColorMap(colors) {
    currentColorMap = {
      0: 'transparent',
      1: colors.primary,
      2: colors.secondary,
      3: colors.dark,
      4: colors.eye,
      5: colors.pupil,
      6: colors.claw || colors.primary,
    };
  }

  function renderFrame(state, frameIndex, flipX = false) {
    if (!currentCanvas || !currentColorMap) return;
    const ctx = currentCanvas.getContext('2d');
    ctx.clearRect(0, 0, SIZE, SIZE);

    const frameSet = STATE_FRAMES[state] || 'idle';
    const frames = FRAMES[frameSet];
    if (!frames) return;

    const frame = frames[frameIndex % frames.length];
    if (!frame) return;

    for (let y = 0; y < GRID; y++) {
      for (let x = 0; x < GRID; x++) {
        const colorCode = frame[y][x];
        if (colorCode === 0) continue;
        const color = currentColorMap[colorCode] || 'transparent';
        if (color === 'transparent') continue;

        ctx.fillStyle = color;
        const drawX = flipX ? (GRID - 1 - x) * PIXEL : x * PIXEL;
        ctx.fillRect(drawX, y * PIXEL, PIXEL, PIXEL);
      }
    }
  }

  function getFrameCount(state) {
    const frameSet = STATE_FRAMES[state] || 'idle';
    return (FRAMES[frameSet] || FRAMES.idle).length;
  }

  /**
   * Set custom frame data (for AI-generated characters)
   * Backs up existing frames and replaces with new ones
   */
  function setCustomFrames(newFrames) {
    if (!originalFrames) {
      originalFrames = {};
      for (const [key, value] of Object.entries(FRAMES)) {
        originalFrames[key] = JSON.parse(JSON.stringify(value));
      }
    }
    for (const [key, value] of Object.entries(newFrames)) {
      if (Array.isArray(value) && value.length > 0) {
        FRAMES[key] = value;
      }
    }
  }

  /**
   * Batch set character data (colors + frames)
   * @param {object} data - { colorMap?, frames? }
   */
  function setCharacterData(data) {
    if (data.colorMap) {
      setColorMap(data.colorMap);
    }
    if (data.frames) {
      setCustomFrames(data.frames);
    }
  }

  /**
   * Reset to original character
   */
  function resetCharacter() {
    if (originalFrames) {
      for (const key of Object.keys(FRAMES)) {
        delete FRAMES[key];
      }
      Object.assign(FRAMES, originalFrames);
      originalFrames = null;
    }
    // Reset to default colors
    setColorMap({
      primary: '#ff4f40',
      secondary: '#ff775f',
      dark: '#8B4513',
      eye: '#ffffff',
      pupil: '#111111',
      claw: '#ff4f40',
    });
  }

  return {
    createCanvas, setColorMap, renderFrame, getFrameCount,
    setCustomFrames, setCharacterData, resetCharacter,
    SIZE, FRAMES, STATE_FRAMES,
  };
})();
